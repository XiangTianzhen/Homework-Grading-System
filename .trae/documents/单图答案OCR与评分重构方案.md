## 目标

* 针对你上传的这张试卷图片，仅识别并校验括号内的手写答案（位置固定）。

* 前端上传→区域 OCR→展示识别文本→与标准答案逐题比对→打分与错题本。

* 清空旧的演示测试与硬编码答案，统一以当前图片模板为“标准”。

## 总体思路

* 建立“单图模板”：记录该图片的分辨率和每个括号答案的矩形区域坐标，以及标准答案列表。

* 工作台在上传后自动加载该模板，直接对模板中的区域调用后端 `POST /ocr/areas`。

* 将每个区域的识别文本映射为 `studentAnswers[i]`，再用 `POST /grade` 与 `standardAnswers[i]` 逐题评分。

* 评分支持数字、分数、小数与单位的归一化（误差容忍与约分）。

## 前端改造

* 路由与工作台：保留 `/workspace`。上传后：

  * 自动选择当前“单图模板”，读取 `areas` 并触发区域 OCR；

  * 在“OCR结果面板”展示每题的识别文本，旁边显示标准答案与得分。

* 模板文件：新增 `frontend/src/templates/primary_math_2023.json`

  * 字段：

    ```json
    {
      "paperId": "primary_math_2023",
      "imageSize": { "width": 1080, "height": 1438 },
      "areas": [
        { "id": "Q1_A", "rect": { "x": 260, "y": 236, "width": 220, "height": 56 } },
        { "id": "Q1_B", "rect": { "x": 840, "y": 236, "width": 180, "height": 56 } },
        { "id": "Q2_A", "rect": { "x": 228, "y": 324, "width": 160, "height": 56 } },
        { "id": "Q2_B", "rect": { "x": 570, "y": 324, "width": 160, "height": 56 } },
        { "id": "Q2_C", "rect": { "x": 832, "y": 324, "width": 160, "height": 56 } }
        // 依次列出所有括号答案区域（以该图片分辨率为基准，坐标将以实际测量微调）
      ],
      "standardAnswers": [
        { "id": "Q1_A", "answer": "1500", "score": 1, "type": "number" },
        { "id": "Q1_B", "answer": "4.05", "score": 1, "type": "number" },
        { "id": "Q2_A", "answer": "12", "score": 1, "type": "number" },
        { "id": "Q2_B", "answer": "32", "score": 1, "type": "number" },
        { "id": "Q2_C", "answer": "40", "score": 1, "type": "number" }
        // 后续题目的标准答案将按题面逐一补齐（分数/单位题型用 type 标注）
      ]
    }
    ```

  * 说明：坐标以实际图片像素测量，后续联调时微调；`type` 用于归一化（number/fraction/unit/choice/short-text）。

* 工作台逻辑：

  * 去除所有硬编码演示答案与“演示评分”分支；

  * 加载模板→ `POST /ocr/areas`→ 组装 `studentAnswers`（按 `areas` 顺序）；

  * 调用 `POST /grade` 并用 `ResultCard` 显示每题的学生答案、标准答案与得分；

  * 支持“保存错题到本地”与“单题重识别”。

## 后端改造

* 保持现有接口不变：`/upload`、`/ocr/areas`、`/grade`。

* 在 `POST /grade` 的实现中启用并默认开启以下容错：

  * 数字：去空格、全角半角、千分位；允许 `±0.01` 小数误差；

  * 分数：约分后比较（如 `2/4 == 1/2`）；

  * 单位：常用单位映射（`米==m`、`厘米==cm`），支持“值+单位”组合；

  * 选择题：近似字符容错（A-D 手写接近字形）；

  * 简答：关键词命中≥阈值记部分分（如命中 2/3）。

* 日志：记录每次区域识别文本摘要与评分结果；不写入任何密钥与隐私数据。

## 清理与重置

* 删除或禁用旧的演示测试与标准答案：

  * 前端 `App.vue` 内的 `standardAnswers` 与“演示评分”分支；

  * 生成器组件的预设文本改为“仅测试入口”，不再影响工作台；

  * 清理 `backend/uploads/` 内的旧样例图片（开发产物）。

## 标准答案编写

* 以图片题面为准，逐题撰写标准答案并标注类型：

  * 示例：`Q1_A=1500`、`Q1_B=4.05`；分数题用 `"type":"fraction"`（如 `7/8`）；单位题用 `"type":"unit"`（如 `2m-5` 兼容 `2 m – 5`）。

* 首次联调流程：先跑区域 OCR 收集识别文本，用肉眼核对题面，最终固化为 `standardAnswers` JSON。

## 验证流程

* 启动：在项目根运行 `npm run dev`；前端通过 `/api/*` 代理到后端。

* 操作：

  * 在工作台上传你的图片；系统自动套用模板、执行区域 OCR；

  * 面板展示：每题的识别文本与标准答案、得分与总分；

  * 失败区域：点击该题“重识别”或微调区域坐标后重试；

  * 错题：可保存到“错题本”，本地存储键 `errorBook`。

## 交付物

* 新模板：`frontend/src/templates/primary_math_2023.json`（坐标 + 标准答案）。

* 前端工作台改造（移除硬编码演示、加载模板并走区域 OCR + 评分）。

* 后端评分容错默认启用，无接口变化。

* 清理旧测试与演示数据。

## 风险与注意

* 坐标对图片分辨率敏感；请固定该图片的分辨率作为模板基准（必要时自动等比缩放并映射坐标）。

* 手写体 OCR 可能在分数与连写数字处偏差，需要开启“单题重识别”和微调区域。

* 安全：不提交任何密钥到仓库；仅使用环境变量 `BAIDU_OCR_API_KEY`、`BAIDU_OCR_SECRET_KEY`。

## 下一步（获得确认后立即执行）

1. 精确标注并录入所有括号答案的区域坐标；
2. 跑一遍区域 OCR，编写并固化完整 `standardAnswers`；
3. 前端移除旧演示逻辑并接入模板；
4. 验证评分与错题本；
5. 清理旧样例图片并完成交付。

